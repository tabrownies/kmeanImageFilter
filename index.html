<!DOCTYPE html>
<html>

<head>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap');
      </style>
    <link href="hex.css" type="text/css" rel="stylesheet">
    <link href="style.css" type="text/css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>
            KMeans Image Filter
        </h1>
        <nav>
            <a href="tabrownies.github.io">Return to Main Site</a>
        </nav>
    </header>
    <div id="mainImage">
        <img src="taxi.jpeg">
    </div>
    <div id="options">
        <h2>Global Settings</h2>
        <ul>
            <li>
                Number of Clusters: <input id="numClustersInput" type="number" onchange="set_num_clusters(event.target.value)">
            </li>
            <li>
                Choose New Image:<button>Choose File</button>
            </li>
        </ul>
        <h2>Color Values</h2>
        <ul>

        </ul>
        <!-- <h2>Advanced Settings</h2>
        <ul>

        </ul> -->
    </div>

    

    <!-- <img id="color" src="taxi.jpeg" /> -->

    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script>
    <script src="kmeans.js"></script>
    <script src="image.js"></script>
    <script src="hex.js"></script>
    <script>
        // global variables defined by the options
        let num_clusters = 5;
        let num_cluster_input_tag = document.getElementById('numClustersInput');
        function set_num_clusters(new_num_clusters, update_input_tag=true){
            // set the number of clusters as a global variable
            const UPPER_NUM_CLUSTERS_BOUND = 100; // the maximum number of clusters allowed by the application
            // if the number of clusters suggested is out of bounds don't update. There could potentially be room to update better by setting high values to the max and non-positives values to 1
            if (new_num_clusters > 0 && new_num_clusters < UPPER_NUM_CLUSTERS_BOUND){
                num_clusters = new_num_clusters
            }
            // runs unless specified otherwise. Updates the DOM to match
            if(update_input_tag){
                num_cluster_input_tag.value = num_clusters
            }
        }
        // run function initially to set number of clusters to 5
        set_num_clusters(5)

        let chooserContainer = document.querySelector('#choosers');
        let chooserControls = [];

        let imageData = null;
        let image = null

        console.log('script is running')
        // process new images using kmeans
        async function process(input) {
            // reset the chooserContainer
            chooserContainer.innerHTML = '';



            let reader = new FileReader();
            reader.onload = async function (e) {
                imageData = await IJS.Image.load(e.target.result)
                image = new Image(imageData, 30);
                imageData = image.export();
                updateImageURLs(imageData)
                // for each color create a way to change the hexvalue
                for (let color of image.clusterColors) {
                    let chooser = createChooserHTML('chooserControls[' + chooserControls.length + ']')
                    chooserContainer.appendChild(chooser);
                    chooserControls.push(new ColorChooser(chooser, color[0], color[1], color[2]));
                }

            }
            reader.readAsDataURL(input.files[0]);
        }

        function changeColors() {
            // break if there is no image to manipulate
            if (!imageData) {
                console.log('image not loaded yet')
                return;
            } else {
                for (let i = 0; i < chooserControls.length; ++i) {
                    image.newColors[i] = [chooserControls[i].r, chooserControls[i].g, chooserControls[i].b];
                }
            }
            imageData = image.export();
            updateImageURLs(imageData);

        }
        // use new image url for both the image and the link for the download
        function updateImageURLs(imageData) {
            document.getElementById('result').src = imageData.toDataURL();
            document.getElementById('download-link').href = imageData.toDataURL();

        }
    </script>

</body>

</html>